name: CI/CD Pipeline

on:
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Release, Debug]
        compiler:
          - { cc: gcc-11, cxx: g++-11 }
          - { cc: clang, cxx: clang++ }
        exclude:
          # macOS doesn't have gcc-11 in default repos
          - os: macos-latest
            compiler: { cc: gcc-11, cxx: g++-11 }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libfmt-dev
          if [ "${{ matrix.compiler.cc }}" = "gcc-11" ]; then
            sudo apt-get install -y gcc-11 g++-11
          fi

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja fmt

      - name: Setup Racket
        uses: Bogdanp/setup-racket@v1.11
        with:
          architecture: "x64"
          distribution: "full"
          variant: "CS"
          version: "8.2"

      - name: Configure CMake
        env:
          CC: ${{ matrix.compiler.cc }}
          CXX: ${{ matrix.compiler.cxx }}
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -G Ninja

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Upload build artifacts
        if: matrix.build_type == 'Release' && matrix.os == 'ubuntu-latest' && matrix.compiler.cc == 'gcc-11'
        uses: actions/upload-artifact@v4
        with:
          name: stratum-binaries
          path: build/bin/
          retention-days: 7

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: stratum-binaries
          path: .

      - name: Run Unit Tests
        run: |
          ls -la
          chmod +x unit_tests
          ./unit_tests

  simulate:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: stratum-binaries
          path: .

      - name: Run default simulation
        run: |
          chmod +x stratum
          ./stratum
          echo "✅ Default simulation completed successfully"

      - name: Run generated experiments
        run: |
          for case in case_*; do
            if [ -x "$case" ]; then
              echo "Running $case..."
              "./$case" > /dev/null
              echo "✅ $(basename $case) completed"
            fi
          done
